SHELL=/bin/bash -O extglob -c
binary := $(shell pwd | rev | cut -d '/' -f 1 | rev)
fq-binary := swallowtail.$(binary)
docker-tag ?= $(fq-binary)
version ?= $(shell git rev-parse HEAD)
repo-base-dir ?= $(shell git rev-parse --show-toplevel)

define DOCKERFILE_CONTENTS
FROM alpine:latest
MAINTAINER alexperkins.crypto@gmail.com
EXPOSE 8080
ADD $(fq-binary) /
RUN apk --no-cache add ca-certificates
ENTRYPOINT ["/$(fq-binary)"]
endef
export DOCKERFILE_CONTENTS

define DOCKERFILEIGNORE_CONTENTS
**/*
!$(fq-binary)
endef
export DOCKERFILEIGNORE_CONTENTS

.PHONY: .dockerignore
.dockerignore: Makefile
	echo "$$DOCKERFILEIGNORE_CONTENTS" > .dockerignore

.PHONY: Dockerfile
Dockerfile: Makefile .dockerignore
	echo "$$DOCKERFILE_CONTENTS" > Dockerfile

.INTERMEDIATE: $(fq-binary)
$(fq-binary): $(shell find . -type f -name "*.go")
	CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -i -installsuffix docker -o $(fq-binary)

.PHONY: docker
.DELETE_ON_ERROR: docker
docker: Dockerfile .dockerignore $(fq-binary)
	docker build -t $(docker-tag) .
